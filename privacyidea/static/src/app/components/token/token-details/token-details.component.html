<div aria-label="Details Tables" class="item-table">
  <mat-grid-list cols="24" rowHeight="7vh">
    <mat-grid-tile [colspan]="24" [rowspan]="1">
      <div class="token-detail-header">
        <h2>Details for Token: </h2>
        <h2 style="color: var(--blue-base)"> {{ serial() }} </h2>
      </div>
    </mat-grid-tile>
    <mat-grid-tile [colspan]="7" [rowspan]="9">
      <div class="info-container">
        <h3>Information: </h3>
        <table [dataSource]="infoData()" aria-label="Token Detail Data Table" class="info-table" mat-table>
          <ng-container matColumnDef="value">
            <th *matHeaderCellDef class="detail-row" mat-header-cell></th>
            <td *matCellDef="let element" class="detail-row editable-row value-td" mat-cell>
              <div class="value-container">
                <mat-list>
                  @for (key of Object.keys(element.value); track key) {
                    @if (isEditingInfo) {
                      <div class="edit-info-row">
                        <mat-list-item class="object-row">
                          <div class="flex">
                            <span class="object-item">{{ key }}: </span>
                            <input matInput class="info-input" [(ngModel)]="element.value[key]"/>
                            <mat-icon class="clickable delete-info-icon" (click)="deleteInfo(key)">delete</mat-icon>
                          </div>
                        </mat-list-item>
                      </div>
                    } @else {
                      <mat-list-item class="object-row">
                        <div class="info-span">
                          <span class="object-item">{{ key }}: </span>
                          <span class="object-item">{{ element.value[key] }}</span>
                        </div>
                      </mat-list-item>
                    }
                  }
                  @if (isEditingInfo) {
                    <mat-list-item class="object-row">
                      <input matInput class="info-input" [(ngModel)]="newInfo().key" placeholder="Add new key"/>:
                      <input matInput class="info-input" [(ngModel)]="newInfo().value" placeholder="Add new info"/>
                    </mat-list-item>
                  }
                </mat-list>
              </div>
          </ng-container>
          <ng-container matColumnDef="edit">
            <th *matHeaderCellDef class="detail-row" mat-header-cell></th>
            <td *matCellDef="let element" class="detail-row edit-column-cell" mat-cell>
              <div class="edit-button-container">
                @if (!isAnyEditing()) {
                  <mat-icon class="edit-button"
                            (click)="toggleEditMode(element, 'info', 'edit')">edit
                  </mat-icon>
                } @else if (!isEditingInfo) {
                  <br/>
                }
                @if (isEditingInfo) {
                  <mat-icon class="edit-button"
                            (click)="toggleEditMode(element, 'info', 'save')">save_as
                  </mat-icon>
                  <mat-icon class="cancel-button"
                            (click)="toggleEditMode(element,'info', 'cancel')">cancel
                  </mat-icon>
                }
              </div>
            </td>
          </ng-container>
          <tr *matRowDef="let row; columns: ['value', 'edit'];" class="detail-row" mat-row></tr>
        </table>
        <br/>
        <mat-divider/>
        <br/>
        <div class="otp-container">
          <div class="pin-input">
            <input [(ngModel)]="fristOTPValue" class="input" placeholder="First OTP value">
            <input [(ngModel)]="secondOTPValue" class="input" placeholder="Second OTP value">
          </div>
          <button (click)="resyncOTPToken()" class="detail-button" extended mat-fab>
            <mat-icon class="detail-button-icon">sync</mat-icon>
            Resync Token
          </button>
          <br/>
          <mat-divider/>
          <br/>
          <div class="pin-input">
            <input style="display:none" type="text"/>
            <input style="display:none" type="password"/>
            <input [(ngModel)]="otpOrPinToTest" [type]="hide ? 'password' : 'text'" class="input-full"
                   placeholder="OTP or PIN">
            <mat-icon (click)="hide = !hide" class="visible-icon" matSuffix>{{ hide ? 'visibility_off' : 'visibility' }}
            </mat-icon>
          </div>
          <button (click)="testToken()" class="detail-button" extended mat-fab>
            <mat-icon class="detail-button-icon">help_outline</mat-icon>
            Test Token
          </button>
          <button (click)="verifyOTPValue()" class="detail-button" extended mat-fab>
            <mat-icon class="detail-button-icon">help_outline</mat-icon>
            Verify OTP value
          </button>
        </div>
      </div>
    </mat-grid-tile>
    <mat-grid-tile [colspan]="9" [rowspan]="9">
      <div class="details-wrapper">
        <div class="details-section">
          <table [dataSource]="detailData()" aria-label="Token Detail Data Table" class="detail-table" mat-table>
            <ng-container matColumnDef="key">
              <th *matHeaderCellDef class="detail-row" mat-header-cell></th>
              <td *matCellDef="let element" class="detail-row" mat-cell>{{ element.keyMap.label }}</td>
            </ng-container>
            <ng-container matColumnDef="value">
              <th *matHeaderCellDef class="detail-row" mat-header-cell></th>
              <td *matCellDef="let element" class="detail-row editable-row" mat-cell>
                @if (element.keyMap.key === "container_serial") {
                  @if (element.isEditing) {
                    <select matNativeControl [(ngModel)]="selectedContainer">
                      @for (option of containerOptions(); track option; ) {
                        <option value="{{ option }}">{{ option }}</option>
                      }
                    </select>
                  } @else {
                    <span>{{ element.value }}</span>
                  }
                } @else if (isObject(element.value) || Array.isArray(element.value)) {
                  @for (info of element.value; track info; let idx = $index) {
                    <mat-list-item class="object-row">
                      <span class="object-item">{{ info }}</span>
                    </mat-list-item>
                  }
                } @else if (element.isEditing) {
                  <input matInput [(ngModel)]="element.value"/>
                } @else {
                  <span
                    [ngClass]="{
            'highlight-true': (element.keyMap.key === 'active' && element.value === true) ||
                            (element.keyMap.key === 'failcount' && element.value == 0),
            'highlight-warning': (element.keyMap.key === 'failcount' && element.value >= 1 && element.value <= 9),
            'highlight-false': (element.keyMap.key === 'active' && element.value !== true) ||
                              (element.keyMap.key === 'failcount' && (element.value < 0 || element.value > 9))
          }">
          {{ element.keyMap.key === 'active' ? (revoked() ? 'revoked' : (element.value ? 'active' : 'deactivated')) : element.value }}
        </span>
                }
              </td>
            </ng-container>
            <ng-container matColumnDef="edit">
              <th *matHeaderCellDef class="detail-row" mat-header-cell></th>
              <td *matCellDef="let element" class="detail-row edit-column-cell" mat-cell>
                @if (element.keyMap.key === "failcount" && !isAnyEditing()) {
                  <mat-icon class="clickable" (click)="resetFailCount()">lock_reset</mat-icon>
                } @else if (element.keyMap.key === "container_serial" && !isAnyEditing() && element.value) {
                  <mat-icon class="clickable red-icon" (click)="unassignContainer()">folder_delete</mat-icon>
                } @else if (element.keyMap.key === "maxfail" || element.keyMap.key === "count_window" || element.keyMap.key === "sync_window"
                || element.keyMap.key === "description" || element.keyMap.key === "info" || element.keyMap.key === "realms"
                || element.keyMap.key === "tokengroup" || element.keyMap.key === "container_serial") {
                  <div class="edit-button-container">
                    @if (!isAnyEditing()) {
                      <mat-icon class="edit-button"
                                (click)="toggleEditMode(element, 'default', 'edit')">edit
                      </mat-icon>
                    } @else if (element.isEditing) {
                      <mat-icon class="edit-button"
                                (click)="toggleEditMode(element, 'default', 'save')">save_as
                      </mat-icon>
                      <mat-icon class="edit-button"
                                (click)="toggleEditMode(element, 'default', 'cancel')" style="color: var(--red-base)">
                        cancel
                      </mat-icon>
                    } @else {
                      <br/>
                    }
                  </div>
                }
              </td>
            </ng-container>
            <tr *matRowDef="let row; columns: ['key', 'value', 'edit'];" class="detail-row" mat-row></tr>
          </table>
        </div>
      </div>
    </mat-grid-tile>
    <mat-grid-tile [colspan]="8" [rowspan]="9">
      <div class="user-details-section">
        <div class="user-container">
          <h3>Assigned User:</h3>
          <table [dataSource]="userData()" aria-label="User Detail Data Table" class="detail-table" mat-table>
            <ng-container matColumnDef="key">
              <th *matHeaderCellDef class="user-detail-row" mat-header-cell></th>
              <td *matCellDef="let element" class="user-detail-row" mat-cell>{{ element.keyMap.label }}</td>
            </ng-container>
            <ng-container matColumnDef="value">
              <th *matHeaderCellDef class="user-detail-row" mat-header-cell></th>
              <td *matCellDef="let element" class="user-detail-row user-editable-row" mat-cell>
                @if (isEditingUser && element.keyMap.key === "username") {
                  <input matInput [(ngModel)]="username"/>
                } @else if (isEditingUser && element.keyMap.key === "user_realm") {
                  <select [(ngModel)]="userRealm">
                    @for (option of realmOptions(); track option; ) {
                      <option value="{{ option }}">{{ option }}</option>
                    }
                  </select>
                } @else {
                  {{ element.value }}
                }
              </td>
            </ng-container>
            <ng-container matColumnDef="edit">
              <th *matHeaderCellDef class="user-detail-row" mat-header-cell></th>
              <td *matCellDef="let element" class="user-detail-row edit-column-cell" mat-cell>
                @if (element.keyMap.key === "username" && !(isAnyEditing() && !this.isEditingUser)) {
                  @if (element.value) {
                    <div class="edit-button-container">
                      <mat-icon class="edit-button yellow-icon"
                                (click)="unassignUser()">
                        person_remove
                      </mat-icon>
                    </div>
                  } @else {
                    <div class="edit-button-container">
                      <mat-icon class="edit-button"
                                (click)="toggleEditMode(element, 'user', 'edit')"
                                [ngClass]="{'red-icon': this.isEditingUser,
                                        'green-icon': !this.isEditingUser}">
                        {{ this.isEditingUser ? 'cancel' : 'person_add' }}
                      </mat-icon>
                    </div>
                  }
                }
              </td>
            </ng-container>
            <tr *matRowDef="let row; columns: ['key', 'value', 'edit'];" class="detail-row" mat-row></tr>
          </table>
          <br/>
          <mat-divider/>
          <br/>
          <div class="user-pin-input">
            <input style="display:none" type="text"/>
            <input style="display:none" type="password"/>
            <input [(ngModel)]="setPinValue" [type]="'password'" class="input" placeholder="Token Pin">
            <input [(ngModel)]="repeatPinValue" [type]="'password'" class="input" placeholder="Repeat Pin">
          </div>
          <div class="user-pin-button">
            @if (!isEditingUser) {
              <button class="detail-button" extended mat-fab (click)="setPin()">
                <mat-icon class="detail-button-icon">password</mat-icon>
                Set Pin
              </button>
              <button class="detail-button" extended mat-fab (click)="setRandomPin()">
                <mat-icon class="detail-button-icon">casino</mat-icon>
                Random Pin
              </button>
            } @else {
              <button class="card-button-activate" extended mat-fab (click)="toggleEditMode(undefined, 'user', 'save')">
                <mat-icon class="detail-button-icon">save</mat-icon>
                Assign User
              </button>
            }
          </div>
        </div>
      </div>
    </mat-grid-tile>
  </mat-grid-list>
</div>
