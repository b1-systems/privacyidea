<div aria-label="Details Tables" class="item-table">
  <mat-grid-list cols="24" rowHeight="6vh">
    <mat-grid-tile [colspan]="24" [rowspan]="1">
      <div class="token-detail-header">
        <h2>Details for Token: </h2>
        <h2 style="color: var(--blue-base)"> {{ serial() }} </h2>
      </div>
    </mat-grid-tile>
    <mat-grid-tile [colspan]="9" [rowspan]="12">
      <div class="details-wrapper">
        <div class="details-section">
          <table [dataSource]="detailData()" aria-label="Token Detail Data Table"
                 class="detail-table" mat-table>
            <ng-container matColumnDef="key">
              <th *matHeaderCellDef class="detail-row" mat-header-cell></th>
              <td *matCellDef="let element" class="detail-row" mat-cell>{{ element.keyMap.label }}
              </td>
            </ng-container>
            <ng-container matColumnDef="value">
              <th *matHeaderCellDef class="detail-row" mat-header-cell></th>
              <td *matCellDef="let element" class="detail-row editable-row" mat-cell>
                @if (element.keyMap.key === "container_serial") {
                  @if (element.isEditing) {
                    <mat-form-field class="detail-table-input">
                      <mat-label>Select Container</mat-label>
                      <mat-select [(ngModel)]="selectedContainer">
                        @for (option of containerOptions(); track option; ) {
                          <mat-option value="{{ option }}">{{ option }}</mat-option>
                        }
                      </mat-select>
                    </mat-form-field>
                  } @else {
                    <span>{{ element.value }}</span>
                  }
                } @else if (element.keyMap.key === "realms") {
                  @if (element.isEditing) {
                    <mat-form-field class="detail-table-input">
                      <mat-label>Select Realms</mat-label>
                      <mat-select [formControl]="selectedRealms" multiple>
                        @for (option of realmOptions(); track option; ) {
                          @if (option === userRealm) {
                            <mat-option value="{{ option }}" disabled>{{ option }}</mat-option>
                          } @else {
                            <mat-option value="{{ option }}">{{ option }}</mat-option>
                          }
                        }
                      </mat-select>
                    </mat-form-field>
                  } @else {
                    @for (realm of element.value; track realm; let idx = $index) {
                      <mat-list-item class="object-row">
                        <span class="object-item">â€¢ {{ realm }}</span>
                      </mat-list-item>
                    }
                  }
                } @else if (element.isEditing && element.keyMap.key !== "maxfail" &&
                element.keyMap.key !== "count_window" && element.keyMap.key !== "sync_window") {
                  <mat-form-field class="detail-table-input">
                    <textarea matInput rows="1" [(ngModel)]="element.value"></textarea>
                  </mat-form-field>
                } @else if (element.isEditing) {
                  <mat-form-field class="detail-table-input">
                    <input type="number" matInput [(ngModel)]="element.value"/>
                  </mat-form-field>
                } @else {
                  <span class="detail-table-item"
                        [ngClass]="tableUtilsService.getClassForKeyMap(element.keyMap.key,
                        element.value, maxfail)">
                    {{
                      tableUtilsService.getDisplayTextForKeyMap(element.keyMap.key, element.value,
                        revoked())
                    }}
                  </span>
                }
              </td>
            </ng-container>
            <ng-container matColumnDef="edit">
              <th *matHeaderCellDef class="detail-row" mat-header-cell></th>
              <td *matCellDef="let element" class="detail-row edit-column-cell" mat-cell>
                @if (element.keyMap.key === "failcount" && !isAnyEditing()) {
                  <div class="edit-button-container">
                    <button mat-icon-button class="edit-button" (click)="resetFailCount()">
                      <mat-icon class="mat-icon-button">
                        lock_reset
                      </mat-icon>
                    </button>
                  </div>
                } @else if (element.keyMap.key === "container_serial" && !isAnyEditing()) {
                  @if (element.value) {
                    <div class="edit-button-container">
                      <button mat-icon-button class="red-icon edit-button"
                              (click)="unassignContainer()">
                        <mat-icon class="mat-icon-button">folder_delete</mat-icon>
                      </button>
                    </div>
                  } @else {
                    <div class="edit-button-container">
                      <button mat-icon-button class="edit-button"
                              (click)="toggleEditMode(element, 'container_serial', 'edit')">
                        <mat-icon class="mat-icon-button">edit</mat-icon>
                      </button>
                    </div>
                  }
                } @else if (element.keyMap.key === "container_serial" && element.isEditing) {
                  <div class="edit-button-container">
                    <button mat-icon-button class="edit-button"
                            (click)="toggleEditMode(element, 'container_serial', 'save')">
                      <mat-icon class="mat-icon-button">save_as</mat-icon>
                    </button>
                    <button mat-icon-button class="edit-button red-icon"
                            (click)="toggleEditMode(element, 'container_serial', 'cancel')">
                      <mat-icon class="mat-icon-button">cancel</mat-icon>
                    </button>
                  </div>
                } @else if (element.keyMap.key === "realms" && element.isEditing) {
                  <div class="edit-button-container">
                    <button mat-icon-button class="edit-button"
                            (click)="toggleEditMode(element, 'realms', 'save')">
                      <mat-icon class="mat-icon-button">save_as</mat-icon>
                    </button>
                    <button mat-icon-button class="edit-button red-icon"
                            (click)="toggleEditMode(element, 'realms', 'cancel')">
                      <mat-icon class="mat-icon-button">cancel</mat-icon>
                    </button>
                  </div>
                } @else if (element.keyMap.key === "maxfail"
                || element.keyMap.key === "count_window"
                || element.keyMap.key === "sync_window"
                || element.keyMap.key === "description"
                || element.keyMap.key === "info"
                || element.keyMap.key === "realms"
                || element.keyMap.key === "tokengroup") {
                  <div class="edit-button-container">
                    @if (!isAnyEditing()) {
                      <button mat-icon-button class="edit-button"
                              (click)="toggleEditMode(element, 'default', 'edit')">
                        <mat-icon class="mat-icon-button">
                          edit
                        </mat-icon>
                      </button>
                    } @else if (element.isEditing) {
                      <button mat-icon-button class="edit-button"
                              (click)="toggleEditMode(element, 'default', 'save')">
                        <mat-icon class="mat-icon-button">save_as</mat-icon>
                      </button>
                      <button mat-icon-button class="edit-button red-icon"
                              (click)="toggleEditMode(element, 'default', 'cancel')">
                        <mat-icon class="mat-icon-button">cancel</mat-icon>
                      </button>
                    } @else {
                      <br/>
                    }
                  </div>
                }
              </td>
            </ng-container>
            <tr *matRowDef="let row; columns: ['key', 'value', 'edit'];" class="detail-row"
                mat-row></tr>
          </table>
        </div>
      </div>
    </mat-grid-tile>
    <mat-grid-tile [colspan]="7" [rowspan]="12">
      <div class="info-container">
        <h3>Information: </h3>
        <table [dataSource]="infoData()" aria-label="Token Detail Data Table" class="info-table"
               mat-table>
          <ng-container matColumnDef="value">
            <th *matHeaderCellDef class="detail-row" mat-header-cell></th>
            <td *matCellDef="let element" class="detail-row editable-row value-td" mat-cell>
              <div class="value-container">
                <mat-list>
                  @for (key of Object.keys(element.value); track key) {
                    @if (isEditingInfo) {
                      <div class="edit-info-row">
                        <mat-list-item class="object-row">
                          <div class="flex">
                            <mat-form-field>
                              <mat-label style="font-size: 14px"
                                         class="object-item">{{ key }}
                              </mat-label>
                              <textarea matInput class="info-input" rows="1"
                                        [(ngModel)]="element.value[key]"></textarea>
                            </mat-form-field>
                            <button mat-icon-button class="delete-info-icon"
                                    (click)="deleteInfo(key)">
                              <mat-icon class="mat-icon-button">delete_outlined</mat-icon>
                            </button>
                          </div>
                        </mat-list-item>
                      </div>
                    } @else {
                      <mat-list-item class="object-row onepx">
                        <div class="info-span">
                          <span style="margin-left: -4px; font-size: 14px" class="object-item">
                            {{ key }}:
                          </span>
                          <span class="object-item"
                                style="margin-left: 2px">{{ element.value[key] }}</span>
                          <mat-divider style="width: 87%; margin-bottom: 5px; margin-left: -8px;
                           margin-top: 3px"/>
                        </div>
                      </mat-list-item>
                    }
                  }
                  @if (isEditingInfo) {
                    <div class="flex">
                      <mat-list-item class="object-row">
                        <mat-form-field style="width: 47%; margin-right: 5px">
                          <input matInput class="info-input" [(ngModel)]="newInfo().key"
                                 placeholder="Add new key"/>:
                        </mat-form-field>
                        <mat-form-field style="width: 51%">
                            <textarea matInput rows="1" class="info-input"
                                      [(ngModel)]="newInfo().value"
                                      placeholder="Add new info"></textarea>
                        </mat-form-field>
                      </mat-list-item>
                    </div>
                  }
                </mat-list>
              </div>
          </ng-container>
          <ng-container matColumnDef="edit">
            <th *matHeaderCellDef class="detail-row" mat-header-cell></th>
            <td *matCellDef="let element" class="detail-row edit-column-cell" mat-cell>
              <div class="edit-button-container">
                @if (!isAnyEditing()) {
                  <button mat-icon-button class="edit-button"
                          (click)="toggleEditMode(element, 'info', 'edit')">
                    <mat-icon class="mat-icon-button">edit
                    </mat-icon>
                  </button>
                } @else if (!isEditingInfo) {
                  <br/>
                }
                @if (isEditingInfo) {
                  <button mat-icon-button class="edit-button"
                          (click)="toggleEditMode(element, 'info', 'save')">
                    <mat-icon class="mat-icon-button">save_as
                    </mat-icon>
                  </button>
                  <button mat-icon-button class="cancel-button"
                          (click)="toggleEditMode(element,'info', 'cancel')">
                    <mat-icon class="mat-icon-button">cancel
                    </mat-icon>
                  </button>
                }
              </div>
            </td>
          </ng-container>
          <tr *matRowDef="let row; columns: ['value', 'edit'];" class="detail-row" mat-row></tr>
        </table>
      </div>
    </mat-grid-tile>
    <mat-grid-tile [colspan]="8" [rowspan]="12">
      <div class="user-details-section">
        <div class="user-container">
          <h3>Assigned User:</h3>
          <table [dataSource]="userData()" aria-label="User Detail Data Table"
                 class="detail-table"
                 mat-table>
            <ng-container matColumnDef="key">
              <th *matHeaderCellDef class="user-detail-row" mat-header-cell></th>
              <td *matCellDef="let element" class="user-detail-row"
                  mat-cell>{{ element.keyMap.label }}
              </td>
            </ng-container>
            <ng-container matColumnDef="value">
              <th *matHeaderCellDef class="user-detail-row" mat-header-cell></th>
              <td *matCellDef="let element" class="user-detail-row user-editable-row" mat-cell>
                @if (isEditingUser && element.keyMap.key === "username" && selectedUserRealm() !== '') {
                  <mat-form-field>
                    <mat-label>Select User</mat-label>
                    <input matInput
                           [formControl]="selectedUsername"
                           [matAutocomplete]="auto">
                    <mat-autocomplete autoActiveFirstOption
                                      #auto="matAutocomplete">
                      @for (option of filteredUserOptions | async; track option) {
                        <mat-option [value]="option">{{ option }}</mat-option>
                      }
                    </mat-autocomplete>
                  </mat-form-field>
                } @else if (isEditingUser && element.keyMap.key === "user_realm") {
                  <mat-form-field>
                    <mat-label>Select Realm of User</mat-label>
                    <mat-select [(ngModel)]="selectedUserRealm">
                      @for (option of realmOptions(); track option; ) {
                        <mat-option value="{{ option }}">{{ option }}</mat-option>
                      }
                    </mat-select>
                  </mat-form-field>
                } @else {
                  {{ element.value }}
                }
              </td>
            </ng-container>
            <ng-container matColumnDef="edit">
              <th *matHeaderCellDef class="user-detail-row" mat-header-cell></th>
              <td *matCellDef="let element" class="user-detail-row edit-column-cell" mat-cell>
                @if (element.keyMap.key === "username" && !(isAnyEditing() && !this.isEditingUser)) {
                  @if (element.value) {
                    <div class="edit-button-container">
                      <button mat-icon-button class="edit-button yellow-icon"
                              (click)="unassignUser()">
                        <mat-icon class="mat-icon-button">person_remove</mat-icon>
                      </button>
                    </div>
                  } @else {
                    <div class="edit-button-container">
                      @if (this.isEditingUser) {
                        <button mat-icon-button class="edit-button red-icon"
                                (click)="toggleEditMode(element, 'user', 'cancel')">
                          <mat-icon class="mat-icon-button">cancel</mat-icon>
                        </button>
                      } @else {
                        <button mat-icon-button class="edit-button green-icon"
                                (click)="toggleEditMode(element, 'user', 'edit')">
                          <mat-icon class="mat-icon-button">person_add</mat-icon>
                        </button>
                      }
                    </div>
                  }
                }
              </td>
            </ng-container>
            <tr *matRowDef="let row; columns: ['key', 'value', 'edit'];" class="detail-row"
                mat-row></tr>
          </table>
          @if (!isEditingUser) {
            <mat-divider style="margin: 0 19px;"/>
          } @else {
            <mat-divider style="margin: 0 19px; border-top-color: white;"/>
          }
          <br/>
          <div class="user-pin">
            <div class="user-pin-input">
              <input style="display:none" type="text"/>
              <input style="display:none" type="password"/>
              <input [(ngModel)]="setPinValue" [type]="'password'" class="input"
                     placeholder="Token Pin">
              <input [(ngModel)]="repeatPinValue" [type]="'password'" class="input"
                     placeholder="Repeat Pin">
            </div>
            <div class="user-pin-button">
              @if (!isEditingUser) {
                <button class="detail-button" extended mat-fab (click)="setPin()">
                  <mat-icon class="detail-button-icon">password</mat-icon>
                  Set Pin
                </button>
                <button class="detail-button" extended mat-fab (click)="setRandomPin()">
                  <mat-icon class="detail-button-icon">casino</mat-icon>
                  Random Pin
                </button>
              } @else {
                <br/>
                <button class="card-button-activate" extended mat-fab
                        (click)="toggleEditMode(undefined, 'user', 'save')">
                  <mat-icon class="detail-button-icon">save</mat-icon>
                  Assign User
                </button>
                <br style="margin-top: 90px;"/>
              }
            </div>
            <mat-divider style="margin: 0 96px;"/>
            <br/>
          </div>
        </div>
        <div class="otp-container">
          <div class="pin-input">
            <input [(ngModel)]="fristOTPValue" class="input" placeholder="First OTP value">
            <input [(ngModel)]="secondOTPValue" class="input" placeholder="Second OTP value">
          </div>
          <div class="pin-input-button">
            <button (click)="resyncOTPToken()" class="detail-button" extended mat-fab>
              <mat-icon class="detail-button-icon">sync</mat-icon>
              Resync Token
            </button>
          </div>
          <mat-divider style="margin: 0 44px;"/>
          <br/>
          <div class="pin-input">
            <input style="display:none" type="text"/>
            <input style="display:none" type="password"/>
            <input [(ngModel)]="otpOrPinToTest" [type]="hide ? 'password' : 'text'"
                   class="input-full"
                   placeholder="OTP or PIN">
            <button (click)="hide = !hide" mat-icon-button
                    matSuffix>
              <mat-icon
                class="visibility-button">{{ hide ? 'visibility_off' : 'visibility' }}
              </mat-icon>
            </button>
          </div>
          <div class="user-pin-button">
            <button (click)="testToken()" class="detail-button" extended mat-fab>
              <mat-icon class="detail-button-icon">help_outline</mat-icon>
              Test Token
            </button>
            <button (click)="verifyOTPValue()" class="detail-button" extended mat-fab>
              <mat-icon class="detail-button-icon">help_outline</mat-icon>
              Verify OTP value
            </button>
          </div>
        </div>
      </div>
    </mat-grid-tile>
  </mat-grid-list>
</div>
