<div aria-label="Details Tables" class="item-table">
  <mat-grid-list cols="23" rowHeight="7vh">
    <mat-grid-tile [colspan]="23" [rowspan]="1">
      <div class="token-detail-header">
        <h2>Details for Token: </h2>
        <h2 style="color: var(--blue-base)"> {{ serial() }} </h2>
      </div>
    </mat-grid-tile>
    <mat-grid-tile [colspan]="9" [rowspan]="9">
      <div class="details-wrapper">
        <div class="details-section">
          <table [dataSource]="detailData()" aria-label="Token Detail Data Table"
                 class="detail-table" mat-table>
            <ng-container matColumnDef="key">
              <th *matHeaderCellDef class="detail-row" mat-header-cell></th>
              <td *matCellDef="let element" class="detail-row" mat-cell>{{ element.keyMap.label }}
              </td>
            </ng-container>
            <ng-container matColumnDef="value">
              <th *matHeaderCellDef class="detail-row" mat-header-cell></th>
              <td *matCellDef="let element" class="detail-row editable-row" mat-cell>
                @if (element.keyMap.key === "container_serial") {
                  @if (element.isEditing()) {
                    <mat-form-field class="detail-table-input">
                      <mat-label>Select Container</mat-label>
                      <input matInput
                             [formControl]="selectedContainer"
                             [matAutocomplete]="containerAuto">
                      <mat-autocomplete autoActiveFirstOption
                                        #containerAuto="matAutocomplete">
                        @for (option of filteredContainerOptions | async; track option) {
                          <mat-option [value]="option">{{ option }}</mat-option>
                        }
                      </mat-autocomplete>
                    </mat-form-field>
                  } @else {
                    <span>{{ element.value }}</span>
                  }
                } @else if (element.keyMap.key === "realms") {
                  @if (element.isEditing()) {
                    <mat-form-field class="detail-table-input">
                      <mat-label>Select Realms</mat-label>
                      <mat-select [formControl]="selectedRealms" multiple>
                        @for (option of realmOptions(); track option; ) {
                          @if (option === userRealm) {
                            <mat-option value="{{ option }}" disabled>{{ option }}</mat-option>
                          } @else {
                            <mat-option value="{{ option }}">{{ option }}</mat-option>
                          }
                        }
                      </mat-select>
                    </mat-form-field>
                  } @else {
                    @for (realm of element.value; track realm; let idx = $index) {
                      <mat-list-item class="object-row">
                        <span class="object-item">• {{ realm }}</span>
                      </mat-list-item>
                    }
                  }
                } @else if (element.keyMap.key === "tokengroup") {
                  @if (element.isEditing()) {
                    <mat-form-field class="detail-table-input">
                      <mat-label>Select Token Group</mat-label>
                      <mat-select [formControl]="selectedTokengroup" multiple>
                        @for (option of tokengroupOptions(); track option; ) {
                          @if (option === userRealm) {
                            <mat-option value="{{ option }}" disabled>{{ option }}</mat-option>
                          } @else {
                            <mat-option value="{{ option }}">{{ option }}</mat-option>
                          }
                        }
                      </mat-select>
                    </mat-form-field>
                  } @else {
                    @for (tokengroup of element.value; track tokengroup; let idx = $index) {
                      <mat-list-item class="object-row">
                        <span class="object-item">• {{ tokengroup }}</span>
                      </mat-list-item>
                    }
                  }
                } @else if (element.isEditing() && element.keyMap.key !== "maxfail" &&
                element.keyMap.key !== "count_window" && element.keyMap.key !== "sync_window") {
                  <mat-form-field class="detail-table-input">
                    <textarea matInput rows="1" class="cut-textarea"
                              [(ngModel)]="element.value"></textarea>
                  </mat-form-field>
                } @else if (element.isEditing()) {
                  <mat-form-field class="detail-table-input">
                    <input type="number" matInput [(ngModel)]="element.value"/>
                  </mat-form-field>
                } @else {
                  <span class="detail-table-item"
                        [ngClass]="tableUtilsService.getClassForKeyMap(element.keyMap.key,
                        element.value, maxfail)">
                    {{
                      tableUtilsService.getDisplayTextForKeyMap(element.keyMap.key, element.value,
                        revoked())
                    }}
                  </span>
                }
              </td>
            </ng-container>
            <ng-container matColumnDef="edit">
              <th *matHeaderCellDef class="detail-row" mat-header-cell></th>
              <td *matCellDef="let element" class="detail-row edit-column-cell" mat-cell>
                @if (element.keyMap.key === "failcount" && !isAnyEditing()) {
                  <div class="edit-button-container">
                    <button mat-icon-button class="edit-button" (click)="resetFailCount()">
                      <mat-icon class="mat-icon-button">
                        lock_reset
                      </mat-icon>
                    </button>
                  </div>
                } @else if (element.keyMap.key === "container_serial" && !isAnyEditing()) {
                  @if (element.value) {
                    <div class="edit-button-container">
                      <button mat-icon-button class="red-icon edit-button"
                              (click)="deleteContainer()">
                        <mat-icon class="mat-icon-button">folder_delete</mat-icon>
                      </button>
                    </div>
                  } @else {
                    <div class="edit-button-container">
                      <button mat-icon-button class="edit-button"
                              (click)="toggleEditMode(element, 'container_serial', 'edit')">
                        <mat-icon class="mat-icon-button">edit</mat-icon>
                      </button>
                    </div>
                  }
                } @else if (element.keyMap.key === "container_serial" && element.isEditing()) {
                  <div class="edit-button-container">
                    <button mat-icon-button class="edit-button"
                            (click)="toggleEditMode(element, 'container_serial', 'save')">
                      <mat-icon class="mat-icon-button">save_as</mat-icon>
                    </button>
                    <button mat-icon-button class="edit-button red-icon"
                            (click)="toggleEditMode(element, 'container_serial', 'cancel')">
                      <mat-icon class="mat-icon-button">cancel</mat-icon>
                    </button>
                  </div>
                } @else if (element.keyMap.key === "maxfail"
                || element.keyMap.key === "count_window"
                || element.keyMap.key === "sync_window"
                || element.keyMap.key === "description"
                || element.keyMap.key === "info"
                || element.keyMap.key === "realms"
                || element.keyMap.key === "tokengroup") {
                  <div class="edit-button-container">
                    @if (!isAnyEditing()) {
                      <button mat-icon-button class="edit-button"
                              (click)="toggleEditMode(element, element.keyMap.key, 'edit')">
                        <mat-icon class="mat-icon-button">
                          edit
                        </mat-icon>
                      </button>
                    } @else if (element.isEditing()) {
                      <button mat-icon-button class="edit-button"
                              (click)="toggleEditMode(element, element.keyMap.key, 'save')">
                        <mat-icon class="mat-icon-button">save_as</mat-icon>
                      </button>
                      <button mat-icon-button class="edit-button red-icon"
                              (click)="toggleEditMode(element, 'default', 'cancel')">
                        <mat-icon class="mat-icon-button">cancel</mat-icon>
                      </button>
                    } @else {
                      <br/>
                    }
                  </div>
                }
              </td>
            </ng-container>
            <tr *matRowDef="let row; columns: ['key', 'value', 'edit'];" class="detail-row"
                mat-row></tr>
          </table>
        </div>
      </div>
    </mat-grid-tile>
    <mat-grid-tile [colspan]="14" [rowspan]="3">
      <app-token-details-user [filteredUserOptions]="filteredUserOptions"
                              [isAnyEditing]="isAnyEditing"
                              [isEditingUser]="isEditingUser"
                              [realmOptions]="realmOptions"
                              [refreshTokenDetails]="refreshTokenDetails"
                              [repeatPinValue]="repeatPinValue"
                              [selectedUserRealm]="selectedUserRealm"
                              [selectedUsername]="selectedUsername"
                              [serial]="serial"
                              [setPinValue]="setPinValue"
                              [userData]="userData"></app-token-details-user>
    </mat-grid-tile>
    <mat-grid-tile [colspan]="9" [rowspan]="6">
      <app-token-details-info [detailData]="detailData" [infoData]="infoData"
                              [isAnyEditing]="isAnyEditing" [isEditingInfo]="isEditingInfo"
                              [refreshTokenDetails]="refreshTokenDetails"
                              [serial]="serial"
      ></app-token-details-info>
    </mat-grid-tile>
    <mat-grid-tile [colspan]="5" [rowspan]="5">
      <div class="otp-container">
        <br/>
        <div class="pin-input">
          <input [(ngModel)]="fristOTPValue" class="input" placeholder="First OTP value">
          <input [(ngModel)]="secondOTPValue" class="input" placeholder="Second OTP value">
        </div>
        <div class="pin-input-button">
          <button (click)="resyncOTPToken()" class="detail-button" extended mat-fab>
            <mat-icon class="detail-button-icon">sync</mat-icon>
            Resync Token
          </button>
        </div>
        <br/>
        <mat-divider/>
        <br/>
        <div class="otp-pin-input">
          <input style="display:none" type="text"/>
          <input style="display:none" type="password"/>
          <input [(ngModel)]="otpOrPinToTest" [type]="hide ? 'password' : 'text'"
                 class="input-full"
                 placeholder="OTP or PIN">
          <button (click)="hide = !hide" class="visibility-button" mat-icon-button
                  matSuffix>
            <mat-icon
              class="visibility-icon">{{ hide ? 'visibility_off' : 'visibility' }}
            </mat-icon>
          </button>
        </div>
        <div class="user-pin-button">
          <button (click)="testToken()" class="detail-button" extended mat-fab>
            <mat-icon class="detail-button-icon">help_outline</mat-icon>
            Test Token
          </button>
          <button (click)="verifyOTPValue()" class="detail-button" extended mat-fab>
            <mat-icon class="detail-button-icon">help_outline</mat-icon>
            Verify OTP value
          </button>
        </div>
      </div>
    </mat-grid-tile>
  </mat-grid-list>
</div>
